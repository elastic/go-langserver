dist: xenial

language: go

go:
  - "1.12.x"

branches:
  only:
    - master

install:
  - git clone https://github.com/elastic/go-langserver $GOPATH/src/golang.org/x/tools
  - cd $GOPATH/src/golang.org/x/tools

git:
  depth: 1

env:
  - GO111MODULE=off GOPROXY=https://proxy.golang.org


before_install:
  - go get golang.org/x/sync/errgroup

matrix:
  fast_finish: true
  allow_failures:
    - os: windows
  include:
    - name: Unit Tests & Package | Linux
      os: linux
      script:
        - go test ./internal/lsp
        - go build -o ../go-langserver-linux-amd64 $GOPATH/src/golang.org/x/tools/cmd/gopls
        - curl -o ../go1.12.7.linux-amd64.tar.gz https://dl.google.com/go/go1.12.7.linux-amd64.tar.gz
        - tar xzf ../go1.12.7.linux-amd64.tar.gz -C ../
        - rm ../go/bin/godoc & rm ../go/bin/gofmt & rm ../go/misc/benchcmp & rm ../go/misc/nacl/go_nacl* & rm -r ../go/pkg/tool/linux_amd64
        - mkdir build
        - tar -zcf ./build/go-langserver-linux-amd64.tar.gz ../go-langserver-linux-amd64 ../go
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN
        local_dir: $GOPATH/src/golang.org/x/tools/build
        on:
          branch: master

    - name: Unit Tests & Package | OSX
      os: osx
      script:
        - go test ./internal/lsp
        - go build -o ../go-langserver-darwin-amd64 $GOPATH/src/golang.org/x/tools/cmd/gopls
        - curl -o ../go1.12.7.darwin-amd64.tar.gz https://dl.google.com/go/go1.12.7.darwin-amd64.tar.gz
        - tar xzf ../go1.12.7.darwin-amd64.tar.gz -C ../
        - rm ../go/bin/godoc & rm ../go/bin/gofmt & rm ../go/misc/benchcmp & rm ../go/misc/nacl/go_nacl* & rm -r ../go/pkg/tool/darwin_amd64
        - mkdir build
        - tar -zcf ./build/go-langserver-darwin-amd64.tar.gz ../go-langserver-darwin-amd64 ../go
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN
        local_dir: $GOPATH/src/golang.org/x/tools/build
        on:
          branch: master

    - name: Unit Tests & Package | Windows
      os: windows
      script:
        # TODO(henrywong) fix the test failures on windows and enable the test.
        # - go test ./internal/lsp
        - go build -o go-langserver-windows-amd64 $GOPATH/src/golang.org/x/tools/cmd/gopls
        - curl -o ../go1.12.7.windows-amd64.zip https://dl.google.com/go/go1.12.7.windows-amd64.zip
        - 7z x ../go1.12.7.windows-amd64.zip -ogo-toolchain
        - rm go-toolchain/go/bin/godoc & rm go-toolchain/go/bin/gofmt & rm go-toolchain/go/misc/benchcmp & rm go-toolchain/go/misc/nacl/go_nacl* & rm -r go-toolchain/go/pkg/tool/windows_amd64
        - mkdir build
        - 7z a -r ./build/go-langserver-windows-amd64.zip go-langserver-windows-amd64 go-toolchain/go
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN
        local_dir: $GOPATH/src/golang.org/x/tools/build
        on:
          branch: master
